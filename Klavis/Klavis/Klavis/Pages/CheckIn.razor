@page "/checkin"

@using Google.Cloud.Firestore;

<PageTitle>Check In</PageTitle>

<h1>Check In</h1>

<div class="col-md-6 col-lg-4 p-3">
    <RadzenCard>
        <h4 class="mb-4">Awaiting ID...</h4>
        <RadzenTextBox @bind-Value=@userIDField MaxLength="8" Change=@(args => OnChange(args, "TextBox with 5 maximum characters")) Class="w-100" />
    </RadzenCard>
</div>

<div class="row">
    <div class="col-xl-6">
        <h3 class="mt-3">Image from url</h3>

        <RadzenImage Path="https://www.radzen.com/assets/hero-40b90af93c7bda2d44608c74e2b8eeb6785e273e02340ec44583d097b5dfb896.png" Style="width: 100%;">
        </RadzenImage>

        <RadzenCard class="m-3">
            <div class="d-flex flex-row">
                <RadzenImage Path=@picturePath Class="rounded-circle float-left mr-3" Style="width: 100px; height: 100px;" />
                <div>
                    <div>Name</div>
                    <b>@(firstName + " " + lastName)</b>
                    <div class="mt-3">BUID</div>
                    <b>@userID</b>
                </div>
            </div>
        </RadzenCard>
    </div>
</div>




@code {
    FirestoreDb klavis_db;
    string security_key_path = "";
    string userIDField;
    string userID;
    string userSerial;
    string location;
    string firstName;
    string lastName;
    string picturePath;
    bool accessStatus;



    void OnChange(string value, string name)
    {
        if (value.Length != 8)
        {
        }
        else
        {
            picturePath = "";
            userID = value;
            firstName = "";
            lastName = "";
            accessStatus = false;
            query_user(userIDField, location);
        }
    }

    private async void query_user(string userIDField, string terminalLocation)
        {
            

            DocumentReference userRef = klavis_db.Collection("access").Document(location).Collection("users").Document(userID);
            DocumentSnapshot snapshot = await userRef.GetSnapshotAsync();
            userID = userIDField;
            if (snapshot.Exists)
            {
                Dictionary<string, object> userDictionary = snapshot.ToDictionary();
                firstName = (string) userDictionary["firstname"];
                lastName = (string) userDictionary["lastname"];
                
                //access_container.Text = "Access Granted";
                //pictureBox1.ImageLocation = (string)userDictionary["pictureLink"];

            }
            else
            {
                firstName = "User not found.";
                //access_container.Text = "Access Denied";
            }

        }
}
